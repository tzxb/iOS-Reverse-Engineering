/*! bridge.js Released v1.4.0 Build 2016-03-14 17:31:11 CST | (C) 2015-2016 yanni4night.com | github.com/yanni4night/NWBridge | MIT */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";function d(a,b,c,d){var h=this;g[a]||(g[a]=(0,e.extend)(!0,{},f)),this.exists=function(){return g[a][b]&&"function"==typeof g[a][b][c]},this.invoke=function(e){var f;if(!h.exists())throw new Error(a+':"'+b+"."+c+'" does not exist');return e?(g[a][b][c](e,d),null):f=g[a][b][c](d)},this.isAsync=function(){if(this.exists()){var d=g[a][b][c];return!!d.__async}return!1}}Object.defineProperty(c,"__esModule",{value:!0}),c.Api=d;var e=a("./extend"),f={location:{href:function(){return location.href},host:function(){return location.host},hostname:function(){return location.hostname},pathname:function(){return location.pathname},port:function(){return location.port},origin:function(){return location.origin},search:function(){return location.search},hash:function(){return location.hash},reload:function(){return location.reload()},assign:function(a){return location.assign(a)},replace:function(a){return location.replace(a)}},localStorage:{enabled:function(){if("undefined"==typeof localStorage)return!1;try{var a="__test_jsbridge__"+Date.now();return localStorage.setItem(a,1),1===+localStorage.getItem(a)}catch(b){return!1}},setItem:function(a,b){localStorage.setItem(a,b)},getItem:function(a){localStorage.getItem(a)},removeItem:function(a){localStorage.removeItem(a)}},cookie:{enabled:function(){return navigator.cookieEnabled},setItem:function(){},getItem:function(){},removeItem:function(){}},navigator:{getUserAgent:function(){return navigator.userAgent}}},g={};d.register=function(a,b,c,d,h){var i=d;if(g[a]=g[a]||(0,e.extend)(!0,{},f),g[a][b]=g[a][b]||{},g[a][b][c])throw new Error('Duplicated "'+b+"."+c+'"');"boolean"!=typeof h&&(h=!1),i.__async=h,g[a][b][c]=i}},{"./extend":7}],2:[function(a,b,c){"use strict";function d(a){return e?setImmediate(a):setTimeout(a)}Object.defineProperty(c,"__esModule",{value:!0}),c.asap=d;var e="function"==typeof setImmediate},{}],3:[function(a,b,c){"use strict";var d=a("./dom-event"),e=a("./extend"),f=a("./queue"),g=a("./message"),h=a("./radio"),i=a("./api"),j=a("./promise"),k=a("./logger"),l=a("./asap"),m={PENDING:"pending",COMPLETE:"complete",ERROR:"error"};window.NWBridge=function(a,b,c){function n(){var a;window[b]={call:function(a,b,c,d){return new j.Promise(function(f,h){if(x()){var i=new g.RequestMessage(t,{cmd:a,method:b,inputData:(0,e.extend)(!0,{},c)},d).on("data",function(a,b){f(b)}).on("error",function(a,b){h(b)});w(i)}else h(new Error("Too often"))})}},a=m.COMPLETE===u?{readyState:m.COMPLETE,register:function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),i.Api.register.apply(i.Api,a),window[b]},system:{version:function(){return j.Promise.resolve(window.HYBRID_INITIAL_DATA.version)},platform:function(){return j.Promise.resolve(window.HYBRID_INITIAL_DATA.platform)}}}:{readyState:m.ERROR},(0,e.extend)(window[b],a),Object.defineProperty?Object.defineProperty(window[b],"version",{value:p,writable:!0,enumerable:!1,configurable:!1}):window[b].version=p}var o,p="1.3.0",q=new f.PriorityQueue({priorityKey:"priority"}),r=new f.Queue,s=!1,t="channel:"+a,u=m.PENDING;if(window[a])throw new Error('"'+a+'" already in use');var v=function(){var a={};s||(k.Logger.log("Bridge ready:",u),a[b.replace(/^([A-Z])/,function(a){return a.toLowerCase()})]=window[b],d.DomEvent.trigger(b+"Ready",a),s=!0)},w=function(a){r.push(a)},x=function(){return!0};q.on("push",function(){(0,l.asap)(function(){var a;void 0!==(a=q.pop())&&a.on("response",function(a,b){w(b)}).on("error",function(a,b){k.Logger.error(b.message)}).flow()})}),r.on("push",function(){var a=r.pop();a&&o.send(a)}),window[a]={send:function(a){k.Logger.log("RECEIVE FROM NATIVE:",a);var b=g.Message.fromMetaString(a,t);return b.isInvalid()?k.Logger.warn("[INVALID]:",a):q.push(b),a||"[DEFAULT]"}};try{o=new h.Radio(window.HYBRID_INITIAL_DATA.platform,c),(0,e.extend)(window[a],o.extension),u=m.COMPLETE}catch(y){u=m.ERROR}n(),v()}},{"./api":1,"./asap":2,"./dom-event":5,"./extend":7,"./logger":8,"./message":9,"./promise":10,"./queue":11,"./radio":12}],4:[function(a,b,c){"use strict";function d(a,b){var c="cb_"+(f+=1)+"_"+(1e7*Math.random()|0);this.getId=function(){return c},this.invoke=function(a){var c,d=null;return a?0!==+a.errNo&&(d=new Error(a.errMsg||"Unknown error")):(a={},d=new Error("No data")),c=b.call(null,d,a.data),this.remove(),c},this.remove=function(){return e[a]?delete e[a][c]:!1},(e[a]||(e[a]={}))[c]=this}Object.defineProperty(c,"__esModule",{value:!0}),c.Callback=d;var e={},f=0;d.findById=function(a,b){return e[b]?e[b][a]:void 0}},{}],5:[function(a,b,c){"use strict";
Object.defineProperty(c,"__esModule",{value:!0}),c.DomEvent=void 0;var d=a("./extend");c.DomEvent={trigger:function(a,b){var c=document.createEvent("Events");c.initEvent(a),(0,d.extend)(c,b),document.dispatchEvent(c)}}},{"./extend":7}],6:[function(a,b,c){"use strict";function d(){var a=this,b={};this.on=function(a,c,d){var e;return e=a.trim().split(/\s+/),e.forEach(function(a){b[a]=b[a]||[],b[a].push({type:a,func:c,thisArg:d})}),this},this.off=function(c,d){var e,f;return e=c.trim().split(/\s+/),e.forEach(function(c){return d?(f=b[c],void(Array.isArray(f)&&(b[c]=f.filter(function(a){return a.func!==d})))):(delete b[c],a)}),a},this.emit=function(c,d){var e,f;return e=c.trim().split(/\s+/),e.forEach(function(a){f=b[a],Array.isArray(f)&&f.forEach(function(a){a.timestamp=Date.now(),a.func.call(a.thisArg||null,a,d)})}),a}}Object.defineProperty(c,"__esModule",{value:!0}),c.Event=d},{}],7:[function(a,b,c){"use strict";function d(a){return a&&"undefined"!=typeof Symbol&&a.constructor===Symbol?"symbol":typeof a}function e(){var a,b,c,f,g,j,k=arguments[0],l=1,m=arguments.length,n=!1;for("boolean"==typeof k?(n=k,k=arguments[1]||{},l=2):("object"!==("undefined"==typeof k?"undefined":d(k))&&"function"!=typeof k||null==k)&&(k={});m>l;++l)if(a=arguments[l],null!=a)for(b in a)c=k[b],f=a[b],k!==f&&(n&&f&&(i(f)||(g=h(f)))?(g?(g=!1,j=c&&h(c)?c:[]):j=c&&i(c)?c:{},k[b]=e(n,j,f)):"undefined"!=typeof f&&(k[b]=f));return k}Object.defineProperty(c,"__esModule",{value:!0}),c.extend=e;var f=Object.prototype.hasOwnProperty,g=Object.prototype.toString,h=function(a){return"function"==typeof Array.isArray?Array.isArray(a):"[object Array]"===g.call(a)},i=c.isPlainObject=function(a){if(!a||"[object Object]"!==g.call(a))return!1;var b=f.call(a,"constructor"),c=a.constructor&&a.constructor.prototype&&f.call(a.constructor.prototype,"isPrototypeOf");if(a.constructor&&!b&&!c)return!1;var d;for(d in a);return"undefined"==typeof d||f.call(a,d)}},{}],8:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});var d="info,log,debug,warn,error".split(","),e=console.log||function(){},f=c.Logger={};d.forEach(function(a){f[a]=function(){(console[a]||e).apply(console,arguments)}})},{}],9:[function(a,b,c){"use strict";function d(a,b){(0,h.extend)(this,{messageType:l.REQUEST,cmd:void 0,method:void 0,callbackId:void 0,inputData:void 0,outputData:void 0},{channelId:a,priority:0},b,new j.Event)}function e(a,b,c){var e,f=3e3;c=0|c||f,(500>c||c>1e4)&&(c=f);var g=!1,j=setTimeout(function(){g=!0,k.remove(),e.emit("error",new Error("Timeout"))},c),k=new i.Callback(a,function(a,b){clearTimeout(j),g||(a?e.emit("error",a):e.emit("data",b))});return e=new d(a,(0,h.extend)(b,{messageType:l.REQUEST,callbackId:k.getId()}))}function f(a,b){return new d(a,(0,h.extend)(b,{messageType:l.RESPONSE}))}Object.defineProperty(c,"__esModule",{value:!0}),c.Message=d,c.RequestMessage=e,c.ResponseMessage=f;var g=a("./api"),h=a("./extend"),i=a("./callback"),j=a("./event"),k=a("./logger"),l=d.MESSAGE_TYPE={REQUEST:"request",RESPONSE:"response",PING:"ping"};(0,h.extend)(d.prototype,{isPing:function(){return this.messageType===l.PING},assemble:function(){return{messageType:this.messageType,cmd:this.cmd,method:this.method,inputData:this.inputData,outputData:this.outputData,callbackId:this.callbackId}},serialize:function(){return JSON.stringify(this.assemble())},isInvalid:function(){return this.messageType!==l.REQUEST&&this.messageType!==l.RESPONSE&&this.messageType!==l.PING||l.RESPONSE===this.messageType&&!this.callbackId||l.REQUEST===this.messageType&&(!this.cmd||!this.method)},flow:function(){var a,b;switch(this.messageType){case l.PING:this.callbackId&&(a=new d(this.channelId,(0,h.extend)(this.assemble(),{messageType:l.PING,outputData:{errNo:"0",errMsg:"success",data:{}}})));break;case l.REQUEST:var c,e=new g.Api(this.channelId,this.cmd,this.method,this.inputData),j=!1;if(e.isAsync())try{return e.invoke(function(c){a=new f(this.channelId,(0,h.extend)(this.assemble(),{outputData:{errNo:b?"-1":"0",errMsg:b?b.message:"success",data:c}})),this.emit("response",a)}.bind(this)),this}catch(m){b=m,k.Logger.error("FLOW REQUEST:",m.message)}try{c=e.invoke(),j=!0}catch(m){b=m,k.Logger.error("FLOW REQUEST:",m.message)}this.callbackId&&(a=new f(this.channelId,(0,h.extend)(this.assemble(),{outputData:{errNo:j?"0":"1",errMsg:j?"success":"failed",data:c||{}}})));break;case l.RESPONSE:var n=i.Callback.findById(this.callbackId,this.channelId);if(!n){k.Logger.error(this.channelId+":"+this.callbackId+" not found");break}try{n.invoke(this.outputData)}catch(m){b=m,k.Logger.error("FLOW RESPONSE:"+m.message)}break;default:k.Logger.warn("UNKNOWN TYPE:"+this.messageType)}return a?this.emit("response",a):b&&this.emit("error",b),this}}),d.fromMetaString=function(a,b){var c;try{c=JSON.parse(a)}catch(e){c={}}return new d(b,c)}},{"./api":1,"./callback":4,"./event":6,"./extend":7,"./logger":8}],10:[function(a,b,c){"use strict";function d(a){return a&&"undefined"!=typeof Symbol&&a.constructor===Symbol?"symbol":typeof a;
}function e(){}function f(a){try{return a.then}catch(b){return s=b,t}}function g(a,b){try{return a(b)}catch(c){return s=c,t}}function h(a,b,c){try{a(b,c)}catch(d){return s=d,t}}function i(a){if("object"!==d(this))throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");this._state=0,this._value=null,this._deferreds=[],a!==e&&p(a,this)}function j(a,b,c){return new a.constructor(function(d,f){var g=new i(e);g.then(d,f),k(a,new o(b,c,g))})}function k(a,b){for(;3===a._state;)a=a._value;return 0===a._state?void a._deferreds.push(b):void(0,r.asap)(function(){var c=1===a._state?b.onFulfilled:b.onRejected;if(null===c)return void(1===a._state?l(b.promise,a._value):m(b.promise,a._value));var d=g(c,a._value);d===t?m(b.promise,s):l(b.promise,d)})}function l(a,b){if(b===a)return m(a,new TypeError("A promise cannot be resolved with itself."));if(b&&("object"===("undefined"==typeof b?"undefined":d(b))||"function"==typeof b)){var c=f(b);if(c===t)return m(a,s);if(c===a.then&&b instanceof i)return a._state=3,a._value=b,void n(a);if("function"==typeof c)return void p(c.bind(b),a)}a._state=1,a._value=b,n(a)}function m(a,b){a._state=2,a._value=b,n(a)}function n(a){for(var b=0;b<a._deferreds.length;b++)k(a,a._deferreds[b]);a._deferreds=null}function o(a,b,c){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.promise=c}function p(a,b){var c=!1,d=h(a,function(a){c||(c=!0,l(b,a))},function(a){c||(c=!0,m(b,a))});c||d!==t||(c=!0,m(b,s))}function q(a){var b=new i(i._noop);return b._state=1,b._value=a,b}Object.defineProperty(c,"__esModule",{value:!0}),c.Promise=i;var r=a("./asap"),s=null,t={};i._noop=e,i.prototype.then=function(a,b){if(this.constructor!==i)return j(this,a,b);var c=new i(e);return k(this,new o(a,b,c)),c},i.prototype["catch"]=function(a){return this.then(null,a)};var u=q(!0),v=q(!1),w=q(null),x=q(void 0),y=q(0),z=q("");i.resolve=function(a){if(a instanceof i)return a;if(null===a)return w;if(void 0===a)return x;if(a===!0)return u;if(a===!1)return v;if(0===a)return y;if(""===a)return z;if("object"===("undefined"==typeof a?"undefined":d(a))||"function"==typeof a)try{var b=a.then;if("function"==typeof b)return new i(b.bind(a))}catch(c){return new i(function(a,b){b(c)})}return q(a)},i.all=function(a){var b=Array.prototype.slice.call(a);return new i(function(a,c){function e(g,h){if(h&&("object"===("undefined"==typeof h?"undefined":d(h))||"function"==typeof h)){if(h instanceof i&&h.then===i.prototype.then){for(;3===h._state;)h=h._value;return 1===h._state?e(g,h._value):(2===h._state&&c(h._value),void h.then(function(a){e(g,a)},c))}var j=h.then;if("function"==typeof j){var k=new i(j.bind(h));return void k.then(function(a){e(g,a)},c)}}b[g]=h,0===--f&&a(b)}if(0===b.length)return a([]);for(var f=b.length,g=0;g<b.length;g++)e(g,b[g])})},i.reject=function(a){return new i(function(b,c){c(a)})},i.race=function(a){return new i(function(b,c){a.forEach(function(a){i.resolve(a).then(b,c)})})},i.prototype["catch"]=function(a){return this.then(null,a)}},{"./asap":2}],11:[function(a,b,c){"use strict";function d(a){function b(){var b=a.priorityKey;return b?(c.sort(function(a,c){return a[b]>c[b]?-1:a[b]<c[b]?1:0}),this):this}var c=[];a=(0,g.extend)({limit:0,priorityKey:null},a),this.top=function(){return c[0]},this.pop=function(){var a=c.shift();return a&&this.emit("pop",a),a},this.push=function(d){if(a.limit>0&&this.size()>=a.limit)throw new Error("Overflow");if(d){var e=a.priorityKey;c[c.length]=d,e&&this.size()>1&&c[c.length-1][e]>c[c.length-2][e]&&b(),this.emit("push",d)}return this},this.empty=function(){return!c.length},this.size=function(){return c.length},this.serialize=function(){return JSON.stringify(c)},this.clear=function(){return c=[],this.emit("clear"),this},(0,g.extend)(this,new f.Event)}function e(a){if(a=(0,g.extend)({priorityKey:"priority"},a),"string"!=typeof a.priorityKey)throw new Error("priorityKey is required");var b=new d(a);return b}Object.defineProperty(c,"__esModule",{value:!0}),c.Queue=d,c.PriorityQueue=e;var f=a("./event"),g=a("./extend")},{"./event":6,"./extend":7}],12:[function(a,b,c){"use strict";function d(a){var b=document.createElement("iframe");b.style.cssText="position:absolute;left:-10000px;display:none;height:0;width:0",b.src=a,document.documentElement.appendChild(b);var c=new g.Queue;this.send=function(d){h.Logger.log("RADIO send:",d.serialize()),c.push(d.assemble()),b.src=a+"trigger-message-fetch"},this.extension={fetch:function(){var a=c.serialize();return c.clear(),h.Logger.log("FETCH:"+a),a}}}function e(a){this.send=function(b){h.Logger.log("RADIO send:",a,b.serialize()),window.prompt(a+b.serialize())},this.extension={}}function f(a,b){switch(String(a).toLowerCase()){case"ios":return new d(b);case"android":return new e(b);default:throw new Error(a+" not supported")}}Object.defineProperty(c,"__esModule",{value:!0}),c.Radio=f;var g=a("./queue"),h=a("./logger");f.isSupported=function(a){return-1!==["android","ios"].indexOf(String(a).toLowerCase());
}},{"./logger":8,"./queue":11}]},{},[3]);
if(!window.__tb_js_bridge){new NWBridge('__tb_js_bridge', 'TiebaJsBridge', 'ctieba://');}